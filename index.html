<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropTech Ecosystem Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .tabs {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.9);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            display: flex;
            gap: 10px;
        }

        .tab-button {
            background: #333;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: #555;
        }

        .tab-button.active {
            background: #4fc3f7;
            color: #000;
        }

        .graph-container {
            width: 100%;
            height: 100%;
            display: none;
        }

        .graph-container.active {
            display: block;
        }

        .graph {
            width: 100%;
            height: 100%;
        }

        .controls {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(20, 20, 20, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            max-width: 300px;
        }

        .controls h1 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #4fc3f7;
        }

        .controls p {
            font-size: 12px;
            line-height: 1.5;
            color: #aaa;
            margin-bottom: 15px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            color: #ccc;
        }

        .control-group input[type="range"] {
            width: 100%;
        }

        .control-group select {
            width: 100%;
            padding: 8px;
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #333;
            border-radius: 5px;
            font-size: 12px;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(20, 20, 20, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            max-width: 250px;
        }

        #legend-mapa {
            left: 20px;
            right: auto;
        }

        .legend h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #4fc3f7;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .legend-item:hover {
            opacity: 1;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
        }

        .stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 20, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            font-size: 12px;
        }

        .stats h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #4fc3f7;
        }

        .stat-item {
            margin-bottom: 5px;
            color: #aaa;
        }

        .stat-value {
            color: #fff;
            font-weight: bold;
        }

        .tooltip {
            position: absolute;
            background: rgba(20, 20, 20, 0.95);
            padding: 12px;
            border-radius: 8px;
            pointer-events: none;
            font-size: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #333;
        }

        .tooltip h4 {
            margin-bottom: 8px;
            color: #4fc3f7;
            font-size: 14px;
        }

        .tooltip p {
            margin: 4px 0;
            color: #ccc;
        }

        .node-label {
            font-size: 10px;
            fill: #fff;
            pointer-events: none;
            text-anchor: middle;
            text-shadow: 0 0 3px rgba(0,0,0,0.8);
        }

        .link {
            stroke: #444;
            stroke-opacity: 0.3;
        }

        .node {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 1.5px;
        }

        .node:hover {
            stroke: #4fc3f7;
            stroke-width: 3px;
        }

        .node.highlighted {
            stroke: #ffc107;
            stroke-width: 3px;
        }

        button {
            background: #4fc3f7;
            color: #000;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            background: #6dd5ff;
        }

        .legend::-webkit-scrollbar {
            width: 6px;
        }

        .legend::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .legend::-webkit-scrollbar-thumb {
            background: #4fc3f7;
            border-radius: 3px;
        }

        .tooltip::-webkit-scrollbar {
            width: 6px;
        }

        .tooltip::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .tooltip::-webkit-scrollbar-thumb {
            background: #4fc3f7;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="tabs">
            <button class="tab-button active" data-tab="mapa">Mapa PropTechs</button>
            <button class="tab-button" data-tab="classificacao">Classifica√ß√£o Matriz</button>
        </div>

        <!-- Mapa PropTechs Graph -->
        <div id="mapa-container" class="graph-container active">
            <svg id="graph-mapa" class="graph"></svg>
            
            <div class="controls" id="controls-mapa">
                <h1>üè¢ PropTech Ecosystem</h1>
                <p>Explore the network of companies and their categories. Zoom, pan, and drag nodes to navigate.</p>
                
                <div class="control-group">
                    <label>Node Size: <span id="nodeSize-mapa">6</span></label>
                    <input type="range" id="nodeSizeSlider-mapa" min="3" max="15" value="6" step="1">
                </div>
                
                <div class="control-group">
                    <label>Link Distance: <span id="linkDistance-mapa">50</span></label>
                    <input type="range" id="linkDistanceSlider-mapa" min="20" max="150" value="50" step="10">
                </div>
                
                <div class="control-group">
                    <label>Filter by Categoria Principal:</label>
                    <select id="categoryFilter-mapa">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Filter by Subcategoria:</label>
                    <select id="subcategoryFilter-mapa">
                        <option value="all">All Subcategories</option>
                    </select>
                </div>
                
                <button id="resetZoom-mapa">Reset View</button>
                <button id="resetSimulation-mapa">Restart Simulation</button>
            </div>

            <div class="legend" id="legend-mapa">
                <h3>Categories</h3>
                <div id="legendContent-mapa"></div>
            </div>

            <div class="stats" id="stats-mapa">
                <h3>Statistics</h3>
                <div class="stat-item">Companies: <span class="stat-value" id="companyCount-mapa">0</span></div>
                <div class="stat-item">Categories: <span class="stat-value" id="categoryCount-mapa">0</span></div>
                <div class="stat-item">Connections: <span class="stat-value" id="connectionCount-mapa">0</span></div>
            </div>

            <div class="tooltip" id="tooltip-mapa"></div>
        </div>

        <!-- Classifica√ß√£o Matriz Graph -->
        <div id="classificacao-container" class="graph-container">
            <svg id="graph-classificacao" class="graph"></svg>
            
            <div class="controls" id="controls-classificacao">
                <h1>üìä Classifica√ß√£o Matriz</h1>
                <p>Explore companies with their vertical and driver classifications.</p>
                
                <div class="control-group">
                    <label>Node Size: <span id="nodeSize-classificacao">6</span></label>
                    <input type="range" id="nodeSizeSlider-classificacao" min="3" max="15" value="6" step="1">
                </div>
                
                <div class="control-group">
                    <label>Link Distance: <span id="linkDistance-classificacao">80</span></label>
                    <input type="range" id="linkDistanceSlider-classificacao" min="20" max="150" value="80" step="10">
                </div>
                
                <div class="control-group">
                    <label>Filter by Vertical:</label>
                    <select id="verticalFilter-classificacao">
                        <option value="all">All Verticals</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Filter by Driver:</label>
                    <select id="driverFilter-classificacao">
                        <option value="all">All Drivers</option>
                    </select>
                </div>
                
                <button id="resetZoom-classificacao">Reset View</button>
                <button id="resetSimulation-classificacao">Restart Simulation</button>
            </div>

            <div class="legend" id="legend-classificacao">
                <h3>Legend</h3>
                <div id="legendContent-classificacao"></div>
            </div>

            <div class="stats" id="stats-classificacao">
                <h3>Statistics</h3>
                <div class="stat-item">Companies: <span class="stat-value" id="companyCount-classificacao">0</span></div>
                <div class="stat-item">Verticals: <span class="stat-value" id="verticalCount-classificacao">0</span></div>
                <div class="stat-item">Drivers: <span class="stat-value" id="driverCount-classificacao">0</span></div>
            </div>

            <div class="tooltip" id="tooltip-classificacao"></div>
        </div>
    </div>

    <script>
        // Configuration
        const width = window.innerWidth;
        const height = window.innerHeight;

        // Tab switching functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.getAttribute('data-tab');
                
                // Update active tab button
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Update active graph container
                document.querySelectorAll('.graph-container').forEach(container => container.classList.remove('active'));
                document.getElementById(`${tab}-container`).classList.add('active');
            });
        });

        // ============================================================================
        // MAPA PROPTECHS VISUALIZATION
        // ============================================================================
        
        const svgMapa = d3.select("#graph-mapa")
            .attr("width", width)
            .attr("height", height);

        const gMapa = svgMapa.append("g");

        const zoomMapa = d3.zoom()
            .scaleExtent([0.1, 10])
            .on("zoom", (event) => {
                gMapa.attr("transform", event.transform);
            });

        svgMapa.call(zoomMapa);

        const tooltipMapa = d3.select("#tooltip-mapa");
        const colorScaleMapa = d3.scaleOrdinal(d3.schemeTableau10);

        let nodesMapa = [];
        let linksMapa = [];
        let simulationMapa;
        let linkMapa, nodeMapa, labelMapa;

        d3.csv("dados/mapa_construtechs_proptechs - P√°gina1.csv").then(data => {
            console.log("Mapa CSV loaded successfully:", data.length, "rows");
            processDataMapa(data);
            createVisualizationMapa();
            updateStatsMapa();
            createLegendMapa();
            setupControlsMapa();
        }).catch(error => {
            console.error("Error loading Mapa CSV:", error);
        });

        function processDataMapa(data) {
            const nodeMap = new Map();
            const categoryNodes = new Map();

            const validData = data.filter(d => d.emresa && d.emresa.trim() !== '');

            validData.forEach((row, index) => {
                const company = row.emresa.trim();
                const catPrincipal = row.categoria_principal?.trim();
                const subcat = row.subcategoria?.trim();

                if (!nodeMap.has(company)) {
                    nodeMap.set(company, {
                        id: company,
                        type: 'company',
                        category: catPrincipal || 'Uncategorized',
                        subcategory: subcat
                    });
                }

                if (catPrincipal && !categoryNodes.has(catPrincipal)) {
                    categoryNodes.set(catPrincipal, {
                        id: catPrincipal,
                        type: 'category',
                        level: 1
                    });
                }

                if (subcat && !categoryNodes.has(subcat)) {
                    categoryNodes.set(subcat, {
                        id: subcat,
                        type: 'subcategory',
                        level: 2,
                        parent: catPrincipal
                    });
                }

                if (catPrincipal) {
                    linksMapa.push({
                        source: company,
                        target: catPrincipal,
                        type: 'primary'
                    });
                }

                if (subcat) {
                    linksMapa.push({
                        source: company,
                        target: subcat,
                        type: 'secondary'
                    });
                    
                    if (catPrincipal && catPrincipal !== subcat) {
                        linksMapa.push({
                            source: subcat,
                            target: catPrincipal,
                            type: 'hierarchy'
                        });
                    }
                }
            });

            nodesMapa = [...nodeMap.values(), ...categoryNodes.values()];
            console.log(`Processed ${nodesMapa.length} nodes and ${linksMapa.length} links`);
        }

        function createVisualizationMapa() {
            simulationMapa = d3.forceSimulation(nodesMapa)
                .force("link", d3.forceLink(linksMapa).id(d => d.id).distance(50))
                .force("charge", d3.forceManyBody().strength(-100))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(10));

            linkMapa = gMapa.append("g")
                .selectAll("line")
                .data(linksMapa)
                .join("line")
                .attr("class", "link")
                .attr("stroke-width", d => d.type === 'hierarchy' ? 2 : 1);

            nodeMapa = gMapa.append("g")
                .selectAll("circle")
                .data(nodesMapa)
                .join("circle")
                .attr("class", "node")
                .attr("r", d => {
                    if (d.type === 'company') return 6;
                    if (d.type === 'category') return 12;
                    return 10;
                })
                .attr("fill", d => {
                    if (d.type === 'company') return colorScaleMapa(d.category);
                    if (d.type === 'category') return '#4fc3f7';
                    return '#ffc107';
                })
                .attr("opacity", d => d.type === 'company' ? 0.8 : 1)
                .call(dragMapa(simulationMapa))
                .on("mouseover", (e, d) => showTooltipMapa(e, d))
                .on("mousemove", moveTooltipMapa)
                .on("mouseout", hideTooltipMapa)
                .on("click", (e, d) => highlightConnectionsMapa(e, d));

            // Create labels for ALL nodes
            labelMapa = gMapa.append("g")
                .selectAll("text")
                .data(nodesMapa)
                .join("text")
                .attr("class", "node-label")
                .attr("dy", -15)
                .text(d => d.id)
                .style("font-size", d => {
                    if (d.type === 'category') return '14px';
                    if (d.type === 'subcategory') return '11px';
                    return '8px'; // company nodes
                })
                .style("font-weight", d => d.type === 'category' ? 'bold' : 'normal');

            simulationMapa.on("tick", () => {
                linkMapa
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                nodeMapa
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                labelMapa
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });
        }

        function dragMapa(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        function showTooltipMapa(event, d) {
            let content = `<h4>${d.id}</h4>`;
            
            if (d.type === 'company') {
                content += `<p><strong>Type:</strong> Company</p>`;
                content += `<p><strong>Category:</strong> ${d.category}</p>`;
                if (d.subcategory) content += `<p><strong>Subcategory:</strong> ${d.subcategory}</p>`;
            } else {
                content += `<p><strong>Type:</strong> ${d.type.replace('_', ' ')}</p>`;
                const connections = linksMapa.filter(l => l.source.id === d.id || l.target.id === d.id).length;
                content += `<p><strong>Connections:</strong> ${connections}</p>`;
            }

            tooltipMapa.html(content).style("display", "block");
        }

        function moveTooltipMapa(event) {
            tooltipMapa
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY + 15) + "px");
        }

        function hideTooltipMapa() {
            tooltipMapa.style("display", "none");
        }

        function highlightConnectionsMapa(event, d) {
            nodeMapa.classed("highlighted", false).attr("opacity", 0.2);
            linkMapa.attr("stroke-opacity", 0.1);

            const connectedNodeIds = new Set([d.id]);
            
            linksMapa.forEach(l => {
                if (l.source.id === d.id || l.target.id === d.id) {
                    connectedNodeIds.add(l.source.id);
                    connectedNodeIds.add(l.target.id);
                }
            });

            nodeMapa.filter(n => connectedNodeIds.has(n.id))
                .classed("highlighted", true)
                .attr("opacity", 1);

            linkMapa.filter(l => l.source.id === d.id || l.target.id === d.id)
                .attr("stroke-opacity", 0.6);

            setTimeout(() => {
                svgMapa.on("click", () => {
                    nodeMapa.classed("highlighted", false).attr("opacity", n => n.type === 'company' ? 0.8 : 1);
                    linkMapa.attr("stroke-opacity", 0.3);
                    svgMapa.on("click", null);
                }, { once: true });
            }, 100);
        }

        function updateStatsMapa() {
            const companies = nodesMapa.filter(n => n.type === 'company').length;
            const categories = new Set(nodesMapa.filter(n => n.type === 'category').map(n => n.id)).size;
            
            d3.select("#companyCount-mapa").text(companies);
            d3.select("#categoryCount-mapa").text(categories);
            d3.select("#connectionCount-mapa").text(linksMapa.length);
        }

        function createLegendMapa() {
            const categories = Array.from(new Set(nodesMapa.filter(n => n.type === 'company').map(n => n.category))).sort();
            const subcategories = Array.from(new Set(nodesMapa.filter(n => n.type === 'company' && n.subcategory).map(n => n.subcategory))).sort();
            
            const categorySelect = d3.select("#categoryFilter-mapa");
            categories.forEach(cat => {
                categorySelect.append("option").attr("value", cat).text(cat);
            });

            const subcategorySelect = d3.select("#subcategoryFilter-mapa");
            subcategories.forEach(subcat => {
                subcategorySelect.append("option").attr("value", subcat).text(subcat);
            });

            const legendContent = d3.select("#legendContent-mapa");
            
            categories.forEach(cat => {
                const item = legendContent.append("div").attr("class", "legend-item");
                item.append("div")
                    .attr("class", "legend-color")
                    .style("background-color", colorScaleMapa(cat));
                item.append("span").text(cat);
                
                item.on("click", () => {
                    categorySelect.property("value", cat);
                    applyFiltersMapa();
                });
            });
        }

        function setupControlsMapa() {
            d3.select("#nodeSizeSlider-mapa").on("input", function() {
                const size = +this.value;
                d3.select("#nodeSize-mapa").text(size);
                nodeMapa.attr("r", d => {
                    if (d.type === 'company') return size;
                    if (d.type === 'category') return size * 2;
                    return size * 1.5;
                });
            });

            d3.select("#linkDistanceSlider-mapa").on("input", function() {
                const distance = +this.value;
                d3.select("#linkDistance-mapa").text(distance);
                simulationMapa.force("link").distance(distance);
                simulationMapa.alpha(0.3).restart();
            });

            d3.select("#categoryFilter-mapa").on("change", function() {
                applyFiltersMapa();
            });

            d3.select("#subcategoryFilter-mapa").on("change", function() {
                applyFiltersMapa();
            });

            d3.select("#resetZoom-mapa").on("click", () => {
                svgMapa.transition().duration(750).call(
                    zoomMapa.transform,
                    d3.zoomIdentity.translate(0, 0).scale(1)
                );
            });

            d3.select("#resetSimulation-mapa").on("click", () => {
                simulationMapa.alpha(1).restart();
            });
        }

        function applyFiltersMapa() {
            const selectedCategory = d3.select("#categoryFilter-mapa").property("value");
            const selectedSubcategory = d3.select("#subcategoryFilter-mapa").property("value");

            if (selectedCategory === "all" && selectedSubcategory === "all") {
                // Show all nodes and links
                nodeMapa.attr("opacity", d => d.type === 'company' ? 0.8 : 1);
                linkMapa.attr("stroke-opacity", 0.3);
                labelMapa.attr("opacity", 1);
            } else {
                // Apply combined filtering
                nodeMapa.attr("opacity", d => {
                    if (d.type === 'company') {
                        let matchesCategory = selectedCategory === "all" || d.category === selectedCategory;
                        let matchesSubcategory = selectedSubcategory === "all" || d.subcategory === selectedSubcategory;
                        
                        // Show company only if it matches both criteria
                        return (matchesCategory && matchesSubcategory) ? 0.8 : 0.1;
                    }
                    
                    // For category and subcategory nodes, check if they're related to matching companies
                    const isRelated = linksMapa.some(l => {
                        if (l.source.id === d.id || l.target.id === d.id) {
                            const company = l.source.type === 'company' ? l.source : l.target;
                            if (company.type === 'company') {
                                let matchesCategory = selectedCategory === "all" || company.category === selectedCategory;
                                let matchesSubcategory = selectedSubcategory === "all" || company.subcategory === selectedSubcategory;
                                return matchesCategory && matchesSubcategory;
                            }
                        }
                        return false;
                    });
                    return isRelated ? 1 : 0.1;
                });

                linkMapa.attr("stroke-opacity", d => {
                    const company = d.source.type === 'company' ? d.source : d.target;
                    if (company.type === 'company') {
                        let matchesCategory = selectedCategory === "all" || company.category === selectedCategory;
                        let matchesSubcategory = selectedSubcategory === "all" || company.subcategory === selectedSubcategory;
                        return (matchesCategory && matchesSubcategory) ? 0.3 : 0.05;
                    }
                    return 0.05;
                });

                labelMapa.attr("opacity", d => {
                    if (d.type === 'company') {
                        let matchesCategory = selectedCategory === "all" || d.category === selectedCategory;
                        let matchesSubcategory = selectedSubcategory === "all" || d.subcategory === selectedSubcategory;
                        return (matchesCategory && matchesSubcategory) ? 1 : 0.1;
                    }
                    
                    const isRelated = linksMapa.some(l => {
                        if (l.source.id === d.id || l.target.id === d.id) {
                            const company = l.source.type === 'company' ? l.source : l.target;
                            if (company.type === 'company') {
                                let matchesCategory = selectedCategory === "all" || company.category === selectedCategory;
                                let matchesSubcategory = selectedSubcategory === "all" || company.subcategory === selectedSubcategory;
                                return matchesCategory && matchesSubcategory;
                            }
                        }
                        return false;
                    });
                    return isRelated ? 1 : 0.1;
                });
            }
        }

        // ============================================================================
        // CLASSIFICA√á√ÉO MATRIZ VISUALIZATION
        // ============================================================================
        
        const svgClassificacao = d3.select("#graph-classificacao")
            .attr("width", width)
            .attr("height", height);

        const gClassificacao = svgClassificacao.append("g");

        const zoomClassificacao = d3.zoom()
            .scaleExtent([0.1, 10])
            .on("zoom", (event) => {
                gClassificacao.attr("transform", event.transform);
            });

        svgClassificacao.call(zoomClassificacao);

        const tooltipClassificacao = d3.select("#tooltip-classificacao");

        let nodesClassificacao = [];
        let linksClassificacao = [];
        let simulationClassificacao;
        let linkClassificacao, nodeClassificacao, labelClassificacao;

        d3.csv("dados/classificacao_proptechs_matriz.csv").then(data => {
            console.log("Classificacao CSV loaded successfully:", data.length, "rows");
            processDataClassificacao(data);
            createVisualizationClassificacao();
            updateStatsClassificacao();
            createLegendClassificacao();
            setupControlsClassificacao();
        }).catch(error => {
            console.error("Error loading Classificacao CSV:", error);
        });

        function processDataClassificacao(data) {
            const nodeMap = new Map();
            const verticalNodes = new Map();
            const driverNodes = new Map();

            // Filter out rows with empty empresa or invalid vertical/driver values
            const validData = data.filter(d => {
                const empresa = d.Empresa?.trim();
                const vertical = d['Vertical sugerido']?.trim();
                const driver = d['Driver sugerido']?.trim();
                
                // Skip if no empresa
                if (!empresa) return false;
                
                // Skip if vertical or driver is empty or contains only "-"
                if (!vertical || vertical === '-' || !driver || driver === '-') return false;
                
                return true;
            });

            validData.forEach(row => {
                const empresa = row.Empresa.trim();
                const vertical = row['Vertical sugerido'].trim();
                const driver = row['Driver sugerido'].trim();
                const justificativa = row.Justificativa?.trim() || '';

                // Create or update company node with multiple classifications
                if (!nodeMap.has(empresa)) {
                    nodeMap.set(empresa, {
                        id: empresa,
                        type: 'company',
                        classifications: []
                    });
                }

                // Add this vertical-driver-justificativa combination
                nodeMap.get(empresa).classifications.push({
                    vertical: vertical,
                    driver: driver,
                    justificativa: justificativa
                });

                if (!verticalNodes.has(vertical)) {
                    verticalNodes.set(vertical, {
                        id: vertical,
                        type: 'vertical'
                    });
                }

                if (!driverNodes.has(driver)) {
                    driverNodes.set(driver, {
                        id: driver,
                        type: 'driver'
                    });
                }

                linksClassificacao.push({
                    source: empresa,
                    target: vertical,
                    type: 'vertical'
                });

                linksClassificacao.push({
                    source: empresa,
                    target: driver,
                    type: 'driver'
                });
            });

            nodesClassificacao = [...nodeMap.values(), ...verticalNodes.values(), ...driverNodes.values()];
            console.log(`Processed ${nodesClassificacao.length} nodes and ${linksClassificacao.length} links`);
            console.log(`Filtered companies: ${validData.length} out of ${data.length}`);
        }

        function createVisualizationClassificacao() {
            simulationClassificacao = d3.forceSimulation(nodesClassificacao)
                .force("link", d3.forceLink(linksClassificacao).id(d => d.id).distance(80))
                .force("charge", d3.forceManyBody().strength(-150))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(15));

            linkClassificacao = gClassificacao.append("g")
                .selectAll("line")
                .data(linksClassificacao)
                .join("line")
                .attr("class", "link")
                .attr("stroke", d => d.type === 'vertical' ? '#7c4dff' : '#ff6b6b')
                .attr("stroke-width", 2);

            nodeClassificacao = gClassificacao.append("g")
                .selectAll("circle")
                .data(nodesClassificacao)
                .join("circle")
                .attr("class", "node")
                .attr("r", d => {
                    if (d.type === 'company') return 6;
                    if (d.type === 'vertical') return 14;
                    return 14;
                })
                .attr("fill", d => {
                    if (d.type === 'company') return '#4fc3f7';
                    if (d.type === 'vertical') return '#7c4dff';
                    return '#ff6b6b';
                })
                .attr("opacity", 0.9)
                .call(dragClassificacao(simulationClassificacao))
                .on("mouseover", (e, d) => showTooltipClassificacao(e, d))
                .on("mousemove", moveTooltipClassificacao)
                .on("mouseout", hideTooltipClassificacao)
                .on("click", (e, d) => highlightConnectionsClassificacao(e, d));

            // Create labels for ALL nodes
            labelClassificacao = gClassificacao.append("g")
                .selectAll("text")
                .data(nodesClassificacao)
                .join("text")
                .attr("class", "node-label")
                .attr("dy", -15)
                .text(d => d.id)
                .style("font-size", d => {
                    if (d.type === 'company') return '8px';
                    return '12px';
                })
                .style("font-weight", d => d.type !== 'company' ? 'bold' : 'normal');

            simulationClassificacao.on("tick", () => {
                linkClassificacao
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                nodeClassificacao
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                labelClassificacao
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });
        }

        function dragClassificacao(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        function showTooltipClassificacao(event, d) {
            let content = `<h4>${d.id}</h4>`;
            
            if (d.type === 'company') {
                content += `<p><strong>Type:</strong> Company</p>`;
                
                // Show all classifications for this company
                if (d.classifications && d.classifications.length > 0) {
                    content += `<div style="margin-top: 10px; border-top: 1px solid #555; padding-top: 8px;">`;
                    d.classifications.forEach((classification, index) => {
                        if (index > 0) {
                            content += `<div style="margin-top: 8px; border-top: 1px solid #333; padding-top: 8px;">`;
                        }
                        content += `<p><strong>Vertical - Driver:</strong> ${classification.vertical} - ${classification.driver}</p>`;
                        if (classification.justificativa) {
                            content += `<p style="font-size: 11px; color: #bbb;"><strong>Justificativa:</strong> ${classification.justificativa}</p>`;
                        }
                        if (index > 0) {
                            content += `</div>`;
                        }
                    });
                    content += `</div>`;
                }
            } else {
                content += `<p><strong>Type:</strong> ${d.type === 'vertical' ? 'Vertical' : 'Driver'}</p>`;
                const connections = linksClassificacao.filter(l => l.source.id === d.id || l.target.id === d.id).length;
                content += `<p><strong>Connections:</strong> ${connections}</p>`;
            }

            tooltipClassificacao.html(content).style("display", "block");
        }

        function moveTooltipClassificacao(event) {
            tooltipClassificacao
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY + 15) + "px");
        }

        function hideTooltipClassificacao() {
            tooltipClassificacao.style("display", "none");
        }

        function highlightConnectionsClassificacao(event, d) {
            nodeClassificacao.classed("highlighted", false).attr("opacity", 0.2);
            linkClassificacao.attr("stroke-opacity", 0.1);

            const connectedNodeIds = new Set([d.id]);
            
            linksClassificacao.forEach(l => {
                if (l.source.id === d.id || l.target.id === d.id) {
                    connectedNodeIds.add(l.source.id);
                    connectedNodeIds.add(l.target.id);
                }
            });

            nodeClassificacao.filter(n => connectedNodeIds.has(n.id))
                .classed("highlighted", true)
                .attr("opacity", 1);

            linkClassificacao.filter(l => l.source.id === d.id || l.target.id === d.id)
                .attr("stroke-opacity", 0.6);

            setTimeout(() => {
                svgClassificacao.on("click", () => {
                    nodeClassificacao.classed("highlighted", false).attr("opacity", 0.9);
                    linkClassificacao.attr("stroke-opacity", 0.3);
                    svgClassificacao.on("click", null);
                }, { once: true });
            }, 100);
        }

        function updateStatsClassificacao() {
            const companies = nodesClassificacao.filter(n => n.type === 'company').length;
            const verticals = nodesClassificacao.filter(n => n.type === 'vertical').length;
            const drivers = nodesClassificacao.filter(n => n.type === 'driver').length;
            
            d3.select("#companyCount-classificacao").text(companies);
            d3.select("#verticalCount-classificacao").text(verticals);
            d3.select("#driverCount-classificacao").text(drivers);
        }

        function createLegendClassificacao() {
            const legendContent = d3.select("#legendContent-classificacao");
            const verticalFilter = d3.select("#verticalFilter-classificacao");
            const driverFilter = d3.select("#driverFilter-classificacao");
            
            // Add legend header items
            const items = [
                { color: '#4fc3f7', label: 'Companies' },
                { color: '#7c4dff', label: 'Verticals' },
                { color: '#ff6b6b', label: 'Drivers' }
            ];
            
            items.forEach(item => {
                const div = legendContent.append("div").attr("class", "legend-item");
                div.append("div")
                    .attr("class", "legend-color")
                    .style("background-color", item.color);
                div.append("span").text(item.label);
            });

            // Get unique verticals and drivers
            const verticals = Array.from(new Set(nodesClassificacao.filter(n => n.type === 'vertical').map(n => n.id))).sort();
            const drivers = Array.from(new Set(nodesClassificacao.filter(n => n.type === 'driver').map(n => n.id))).sort();

            // Populate Vertical dropdown
            verticals.forEach(v => {
                verticalFilter.append("option").attr("value", v).text(v);
            });
            
            // Populate Driver dropdown
            drivers.forEach(d => {
                driverFilter.append("option").attr("value", d).text(d);
            });

            // Add separator in legend
            legendContent.append("div").style("border-top", "1px solid #333").style("margin", "10px 0");
            legendContent.append("div").style("font-size", "11px").style("color", "#999").text("Click to filter:");

            // Add Verticals to legend as clickable items
            if (verticals.length > 0) {
                verticals.forEach(v => {
                    const item = legendContent.append("div").attr("class", "legend-item");
                    item.append("div")
                        .attr("class", "legend-color")
                        .style("background-color", '#7c4dff');
                    item.append("span").text(v).style("font-size", "10px");
                    
                    item.on("click", () => {
                        verticalFilter.property("value", v);
                        applyFiltersClassificacao();
                    });
                });
            }
            
            // Add separator
            legendContent.append("div").style("border-top", "1px solid #333").style("margin", "10px 0");
            
            // Add Drivers to legend as clickable items
            if (drivers.length > 0) {
                drivers.forEach(d => {
                    const item = legendContent.append("div").attr("class", "legend-item");
                    item.append("div")
                        .attr("class", "legend-color")
                        .style("background-color", '#ff6b6b');
                    item.append("span").text(d).style("font-size", "10px");
                    
                    item.on("click", () => {
                        driverFilter.property("value", d);
                        applyFiltersClassificacao();
                    });
                });
            }
        }

        function setupControlsClassificacao() {
            d3.select("#nodeSizeSlider-classificacao").on("input", function() {
                const size = +this.value;
                d3.select("#nodeSize-classificacao").text(size);
                nodeClassificacao.attr("r", d => {
                    if (d.type === 'company') return size;
                    return size * 2;
                });
            });

            d3.select("#linkDistanceSlider-classificacao").on("input", function() {
                const distance = +this.value;
                d3.select("#linkDistance-classificacao").text(distance);
                simulationClassificacao.force("link").distance(distance);
                simulationClassificacao.alpha(0.3).restart();
            });

            d3.select("#verticalFilter-classificacao").on("change", function() {
                applyFiltersClassificacao();
            });

            d3.select("#driverFilter-classificacao").on("change", function() {
                applyFiltersClassificacao();
            });

            d3.select("#resetZoom-classificacao").on("click", () => {
                svgClassificacao.transition().duration(750).call(
                    zoomClassificacao.transform,
                    d3.zoomIdentity.translate(0, 0).scale(1)
                );
            });

            d3.select("#resetSimulation-classificacao").on("click", () => {
                simulationClassificacao.alpha(1).restart();
            });
        }

        function applyFiltersClassificacao() {
            const selectedVertical = d3.select("#verticalFilter-classificacao").property("value");
            const selectedDriver = d3.select("#driverFilter-classificacao").property("value");

            if (selectedVertical === "all" && selectedDriver === "all") {
                // Show all nodes and links
                nodeClassificacao.attr("opacity", 0.9);
                linkClassificacao.attr("stroke-opacity", 0.3);
                labelClassificacao.attr("opacity", 1);
            } else {
                // Apply combined filtering
                nodeClassificacao.attr("opacity", d => {
                    // Always show selected vertical and driver nodes
                    if (d.type === 'vertical' && (selectedVertical === "all" || d.id === selectedVertical)) return 1;
                    if (d.type === 'driver' && (selectedDriver === "all" || d.id === selectedDriver)) return 1;
                    
                    // Dim non-selected category nodes
                    if (d.type === 'vertical' && selectedVertical !== "all" && d.id !== selectedVertical) return 0.1;
                    if (d.type === 'driver' && selectedDriver !== "all" && d.id !== selectedDriver) return 0.1;
                    
                    // For companies, check if they match the filter criteria
                    if (d.type === 'company') {
                        let matchesVertical = selectedVertical === "all";
                        let matchesDriver = selectedDriver === "all";
                        
                        if (selectedVertical !== "all") {
                            matchesVertical = linksClassificacao.some(l => 
                                l.type === 'vertical' && 
                                l.source.id === d.id && 
                                l.target.id === selectedVertical
                            );
                        }
                        
                        if (selectedDriver !== "all") {
                            matchesDriver = linksClassificacao.some(l => 
                                l.type === 'driver' && 
                                l.source.id === d.id && 
                                l.target.id === selectedDriver
                            );
                        }
                        
                        // Show company only if it matches both criteria
                        return (matchesVertical && matchesDriver) ? 0.9 : 0.1;
                    }
                    
                    return 0.1;
                });

                linkClassificacao.attr("stroke-opacity", d => {
                    let showLink = false;
                    
                    if (d.type === 'vertical') {
                        showLink = (selectedVertical === "all" || d.target.id === selectedVertical);
                    } else if (d.type === 'driver') {
                        showLink = (selectedDriver === "all" || d.target.id === selectedDriver);
                    }
                    
                    // Only show links for companies that pass the filter
                    if (showLink && d.source.type === 'company') {
                        const companyNode = nodesClassificacao.find(n => n.id === d.source.id);
                        if (companyNode) {
                            let matchesVertical = selectedVertical === "all";
                            let matchesDriver = selectedDriver === "all";
                            
                            if (selectedVertical !== "all") {
                                matchesVertical = linksClassificacao.some(l => 
                                    l.type === 'vertical' && 
                                    l.source.id === companyNode.id && 
                                    l.target.id === selectedVertical
                                );
                            }
                            
                            if (selectedDriver !== "all") {
                                matchesDriver = linksClassificacao.some(l => 
                                    l.type === 'driver' && 
                                    l.source.id === companyNode.id && 
                                    l.target.id === selectedDriver
                                );
                            }
                            
                            showLink = matchesVertical && matchesDriver;
                        }
                    }
                    
                    return showLink ? 0.6 : 0.05;
                });

                labelClassificacao.attr("opacity", d => {
                    if (d.type === 'vertical' && (selectedVertical === "all" || d.id === selectedVertical)) return 1;
                    if (d.type === 'driver' && (selectedDriver === "all" || d.id === selectedDriver)) return 1;
                    if (d.type === 'vertical' && selectedVertical !== "all" && d.id !== selectedVertical) return 0.1;
                    if (d.type === 'driver' && selectedDriver !== "all" && d.id !== selectedDriver) return 0.1;
                    
                    if (d.type === 'company') {
                        let matchesVertical = selectedVertical === "all";
                        let matchesDriver = selectedDriver === "all";
                        
                        if (selectedVertical !== "all") {
                            matchesVertical = linksClassificacao.some(l => 
                                l.type === 'vertical' && 
                                l.source.id === d.id && 
                                l.target.id === selectedVertical
                            );
                        }
                        
                        if (selectedDriver !== "all") {
                            matchesDriver = linksClassificacao.some(l => 
                                l.type === 'driver' && 
                                l.source.id === d.id && 
                                l.target.id === selectedDriver
                            );
                        }
                        
                        return (matchesVertical && matchesDriver) ? 1 : 0.1;
                    }
                    
                    return 0.1;
                });
            }
        }

        // Handle window resize
        window.addEventListener("resize", () => {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            
            svgMapa.attr("width", newWidth).attr("height", newHeight);
            simulationMapa.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
            simulationMapa.alpha(0.3).restart();
            
            svgClassificacao.attr("width", newWidth).attr("height", newHeight);
            simulationClassificacao.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
            simulationClassificacao.alpha(0.3).restart();
        });
    </script>
</body>
</html>

